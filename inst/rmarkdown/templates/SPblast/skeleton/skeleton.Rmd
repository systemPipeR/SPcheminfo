---
title: "BLAST Workflow Template" 
author: "Author: Daniela Cassol (danielac@ucr.edu) and Thomas Girke (thomas.girke@ucr.edu)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  BiocStyle::html_document:
    toc_float: true
    code_folding: show
package: systemPipeR
vignette: |
  %\VignetteIndexEntry{SPcheminfo Workflow Template}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
fontsize: 14pt
bibliography: bibtex.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
suppressPackageStartupMessages({
    library(systemPipeR)
})
```

# Introduction

The [Basic Local Alignment Search Tool (BLAST)](https://blast.ncbi.nlm.nih.gov/Blast.cgi) finds regions of local similarity between sequences. 

| BLAST Tool | Query Type | Database Type | Description                                                 |
|------------|------------|---------------|-------------------------------------------------------------|
| `blastn`     | Nucleotide | Nucleotide    | Search a nucleotide database using a nucleotide query       |
| `blastx`     | Nucleotide | Protein       | Search protein database using a translated nucleotide query |
| `tblastn`    | Protein    | Nucleotide    | Search translated nucleotide database using a protein query |
| `blastp`     | Protein    | Protein       | Search protein database using a protein query               |

## Experimental design

Typically, users want to specify here all information relevant for the analysis
of their NGS study. This includes detailed descriptions of FASTQ files,
experimental design, reference genome, gene annotations, etc. 

# Workflow environment

## Load packages and sample data

The `systemPipeR` package needs to be loaded to perform the analysis 
steps shown in this report [@H_Backman2016-bt]. The package allows users
to run the entire analysis workflow interactively or with a single command 
while also generating the corresponding analysis report. For details
see `systemPipeR's` main [vignette](http://www.bioconductor.org/packages/devel/bioc/vignettes/systemPipeR/inst/doc/systemPipeR.html).

```{r load_systempiper, eval=TRUE, message=FALSE, warning=FALSE}
library(systemPipeR)
library(SPcheminfo)
```

## Setup and Requirements

To go through this tutorial, you need the following software installed:

* R/>=4.0.3
* systemPipeR R package (version 1.24)
* blastp: 2.9.0+

If you desire to build your pipeline with any different software, make sure to have the respective software installed and configured in your PATH. To make sure if the configuration is right, you always can test as follow:

```{r tryCL, eval=TRUE}
tryCL(command = "blastp")  
```

## Generate workflow environment

[*systemPipeRdata*](http://bioconductor.org/packages/release/data/experiment/html/systemPipeRdata.html) package is a helper package to generate a fully populated [*systemPipeR*](http://bioconductor.org/packages/release/bioc/html/systemPipeR.html)
workflow environment in the current working directory with a single command. 
All the instruction for generating the workflow template are provide in the *systemPipeRdata* vignette [here](http://www.bioconductor.org/packages/devel/data/experiment/vignettes/systemPipeRdata/inst/doc/systemPipeRdata.html#1_Introduction). 

After building and loading the workflow environment generated by `genWorkenvir` 
from *systemPipeRdata* all data inputs are stored in
a `data/` directory and all analysis results will be written to a separate
`results/` directory, while the `SPcheminfo.Rmd` script and the `targets` file are expected to be located in the parent directory. The R session is expected to run from this parent
directory. Additional parameter files are stored under `param/`.

To work with real data, users want to organize their own data similarly
and substitute all test data for their own data. To rerun an established
workflow on new data, the initial `targets` file along with the corresponding
FASTQ files are usually the only inputs the user needs to provide.

For more details, please consult the documentation 
[here](http://www.bioconductor.org/packages/release/bioc/vignettes/systemPipeR/inst/doc/systemPipeR.html). More information about the `targets` files from *systemPipeR* can be found [here](http://www.bioconductor.org/packages/release/bioc/vignettes/systemPipeR/inst/doc/systemPipeR.html#25_structure_of_targets_file). 

## Get Data

We are using for this tutorial mouse and human [RefSeq](ftp://ftp.ncbi.nih.gov/refseq/) 
protein data sets from NCBI. 
First, we download the required dataset to `data/` folder and decompressing files, as follows:

```{r download.data, eval=FALSE}
## add as step
download.file("ftp://ftp.ncbi.nih.gov/refseq/M_musculus/mRNA_Prot/mouse.1.protein.faa.gz", 
              destfile = "data/mouse.1.protein.faa.gz")
R.utils::gunzip("data/mouse.1.protein.faa.gz")
# download.file("ftp://ftp.ncbi.nih.gov/refseq/M_musculus/mRNA_Prot/mouse.2.protein.faa.gz", 
#               destfile = "data/mouse.2.protein.faa.gz")
# R.utils::gunzip("data/mouse.2.protein.faa.gz")
download.file("ftp://ftp.ncbi.nih.gov/refseq/H_sapiens/mRNA_Prot/human.1.protein.faa.gz",
              destfile = "data/human.1.protein.faa.gz")
R.utils::gunzip("data/human.1.protein.faa.gz")
```


```{r subset_data, eval=FALSE}
library(Biostrings)
mouse.path <- system.file("extdata", "data/mouse.1.protein.faa", package="SPcheminfo")
mouse.path <- "data/mouse.1.protein.faa"
select <- readAAStringSet(mouse.path)
select <- select[1:3]
writeXStringSet(select, "data/mouse_select.fasta", format="fasta")
```

## Project initialization

To create a Workflow within _`systemPipeR`_, we can start by defining an empty
container and checking the directory structure:

```{r SPRproject, eval=TRUE}
sal <- SPRproject() 
```

## Create workflow

```{r, eval=TRUE, spr=TRUE}
appendStep(sal) <- SYSargsList(step_name = "makeblastdb", 
                               targets = NULL, dir = FALSE,
                               wf_file="blast/makeblastdb.cwl", input_file="blast/makeblastdb.yml",
                               dir_path = system.file("extdata/cwl", package="systemPipeR"))
```

```{r blastp, eval=TRUE, spr=TRUE}
appendStep(sal) <- SYSargsList(step_name = "blastp", 
                               targets = NULL, dir = TRUE,
                               wf_file="blast/blastp.cwl", input_file="blast/blastp.yml",
                               dir_path = system.file("extdata/cwl", package="systemPipeR"), 
                               dependency = "makeblastdb")
```

```{r top_hits, eval=TRUE, spr=TRUE}
appendStep(sal) <- SYSargsList(step_name = "top_hits", 
                               targets = NULL, dir = TRUE,
                               wf_file="blast/cat.cwl", input_file="blast/cat.yml",
                               dir_path = system.file("extdata/cwl", package="systemPipeR"), 
                               dependency = "blastp")
```

```{r blastdbcmd, eval=TRUE, spr=TRUE}
appendStep(sal) <- SYSargsList(step_name = "blastdbcmd", 
                               targets = NULL, dir = TRUE,
                               wf_file="blast/blastdbcmd.cwl", input_file="blast/blastdbcmd.yml",
                               dir_path = system.file("extdata/cwl", package="systemPipeR"), 
                              dependency = "top_hits")
```

## Run workflow

For running the workflow, `runWF` function will execute all the command lines store in the workflow container.

```{r, eval=FALSE}
sal <- runWF(sal)
```

## Workflow Visualization

systemPipeR workflows instances can be visualized with the `plotWF` function.

```{r, eval=TRUE}
plotWF(sal)
```

# Version Information

```{r sessionInfo}
sessionInfo()
```

# Funding

This project is funded by NSF award ABI-1661152.

# References
